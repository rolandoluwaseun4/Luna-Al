<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Luna AI</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      height: 100dvh;
      display: flex;
      flex-direction: column;
      background: #07080f;
      color: #d8e4ff;
      font-family: system-ui, sans-serif;
      overflow: hidden;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.07);
      flex-shrink: 0;
    }

    .avatar {
      width: 36px; height: 36px;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #d4e4ff, #5070c0);
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }

    .header h1 { font-size: 16px; color: #c8d8f8; }
    .header p  { font-size: 11px; color: #7080aa; }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 14px 12px 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .row { display: flex; align-items: flex-end; gap: 6px; }
    .row.user { justify-content: flex-end; }

    .bubble {
      max-width: 75%;
      padding: 9px 13px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.5;
      word-break: break-word;
    }

    .row.user .bubble {
      background: #1a2a5e;
      border: 1px solid rgba(91,127,224,0.35);
      border-bottom-right-radius: 4px;
    }

    .row.luna .bubble {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(180,200,255,0.1);
      border-bottom-left-radius: 4px;
    }

    .time {
      font-size: 10px;
      color: #7080aa;
      margin-top: 2px;
      padding: 0 4px;
    }
    .row.user .time { text-align: right; }

    .typing { display: none; align-items: center; gap: 6px; }
    .typing.on { display: flex; }
    .dots {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(180,200,255,0.1);
      border-radius: 18px;
      border-bottom-left-radius: 4px;
      padding: 10px 14px;
      display: flex; gap: 4px;
    }
    .dots span {
      width: 6px; height: 6px;
      background: #8099cc;
      border-radius: 50%;
      animation: bounce 1.2s infinite;
    }
    .dots span:nth-child(2) { animation-delay: 0.15s; }
    .dots span:nth-child(3) { animation-delay: 0.3s; }
    @keyframes bounce {
      0%,60%,100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }

    .input-area {
      padding: 8px 12px max(8px, env(safe-area-inset-bottom));
      flex-shrink: 0;
      border-top: 1px solid rgba(255,255,255,0.07);
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(180,200,255,0.1);
      border-radius: 24px;
      padding: 6px 6px 6px 14px;
    }

    textarea {
      flex: 1;
      background: none;
      border: none;
      outline: none;
      color: #d8e4ff;
      font-family: inherit;
      font-size: 14px;
      resize: none;
      max-height: 90px;
      padding: 4px 0;
    }
    textarea::placeholder { color: #7080aa; }

    button {
      width: 36px; height: 36px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #4060cc, #7090e8);
      color: white;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    button:disabled { opacity: 0.4; }
    button svg { width: 16px; height: 16px; fill: white; }

    .intro {
      text-align: center;
      padding: 30px 10px 10px;
      color: #7080aa;
    }
    .intro span { font-size: 36px; display: block; margin-bottom: 8px; }
    .intro h2 { font-size: 18px; color: #c8d8f8; margin-bottom: 4px; }
    .intro p { font-size: 13px; }
  </style>
</head>
<body>

<div class="header">
  <div class="avatar">ðŸŒ™</div>
  <div>
    <h1>Luna ðŸ’—</h1>
    <p>Personal AI Â· Always here</p>
  </div>
</div>

<div class="messages" id="messages">
  <div class="intro">
    <span>ðŸŒ™</span>
    <h2>Hey, I'm Luna!</h2>
    <p>Ask me anything.</p>
  </div>
  <div class="typing" id="typing">
    <div style="width:26px;height:26px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#d4e4ff,#5070c0);display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;">ðŸŒ™</div>
    <div class="dots"><span></span><span></span><span></span></div>
  </div>
</div>

<div class="input-area">
  <div class="input-row">
    <textarea id="input" placeholder="Message Luna..." rows="1"></textarea>
    <button id="send" disabled>
      <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
  </div>
</div>

<script>
  const BACKEND_URL = 'https://YOUR-RAILWAY-APP.up.railway.app';

  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); }

  const userId = tg?.initDataUnsafe?.user?.id || null;

  const msgsEl = document.getElementById('messages');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('send');
  const typingEl = document.getElementById('typing');

  let busy = false;

  inputEl.addEventListener('input', () => {
    inputEl.style.height = 'auto';
    inputEl.style.height = Math.min(inputEl.scrollHeight, 90) + 'px';
    sendBtn.disabled = !inputEl.value.trim() || busy;
  });

  inputEl.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
  });

  sendBtn.addEventListener('click', send);

  function time() {
    return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function addMsg(role, text) {
    const row = document.createElement('div');
    row.className = `row ${role}`;
    row.innerHTML = `
      ${role === 'luna' ? `<div style="width:26px;height:26px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#d4e4ff,#5070c0);display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;">ðŸŒ™</div>` : ''}
      <div>
        <div class="bubble">${text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>')}</div>
        <div class="time">${time()}</div>
      </div>
    `;
    msgsEl.insertBefore(row, typingEl);
    msgsEl.scrollTop = msgsEl.scrollHeight;
  }

  async function send() {
    const text = inputEl.value.trim();
    if (!text || busy) return;

    inputEl.value = '';
    inputEl.style.height = 'auto';
    sendBtn.disabled = true;
    busy = true;

    addMsg('user', text);
    typingEl.classList.add('on');
    msgsEl.scrollTop = msgsEl.scrollHeight;

    try {
      const res = await fetch(`${BACKEND_URL}/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text, userId })
      });
      const data = await res.json();
      typingEl.classList.remove('on');
      addMsg('luna', data.reply || "Hmm, no response.");
    } catch {
      typingEl.classList.remove('on');
      addMsg('luna', "Couldn't reach Luna. Check your connection. ðŸ˜…");
    }

    busy = false;
    sendBtn.disabled = !inputEl.value.trim();
  }
</script>
</body>
</html>
